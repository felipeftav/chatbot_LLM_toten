<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistente Virtual</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body class="bg-amber-400 flex items-center justify-center h-screen p-4">

    <div id="splash-screen" class="bg-white p-8 rounded-2xl shadow-2xl w-full">

        <div id="splash-content">
            <h1 class="text-4xl font-bold text-zinc-900 mb-2 text-center">Bem-vindo ao Metaday!</h1>
            <p class="text-slate-600 text-lg mb-8 text-center">Antes de conversar com a <b>LIA (Assistente de IA)</b>, conte-nos um pouco sobre você.</p>
            
            <form id="start-form">
                <div class="space-y-4">
                    <div>
                        <label for="name-input" class="block text-left text-lg font-bold text-slate-700 mb-2">Qual é o seu nome?</label>
                        <input type="text" id="name-input" placeholder="Digite seu nome aqui" required class="w-full p-4 text-lg border-2 border-slate-300 rounded-full focus:outline-none focus:ring-4 focus:ring-indigo-300 transition duration-300">
                    </div>
                    <div>
                        <label for="role-select" class="block text-left text-lg font-bold text-slate-700 mb-2">Você é:</label>
                        <select id="role-select" class="w-full p-4 text-lg border-2 border-slate-300 rounded-full focus:outline-none focus:ring-4 focus:ring-indigo-300 transition duration-300">
                            <option value="aluno">Aluno(a)</option>
                            <option value="visitante">Visitante</option>
                            <option value="professor">Professor(a)</option>
                        </select>
                    </div>
                    <div>
                        <label for="interest-area-select" class="block text-left text-lg font-bold text-slate-700 mb-2">Qual sua área de maior interesse?</label>
                        <select id="interest-area-select" class="w-full p-4 text-lg border-2 border-slate-300 rounded-full focus:outline-none focus:ring-4 focus:ring-indigo-300 transition duration-300">
                            <option value="Negócios e Inovação">Gestão de Negócios e Inovação</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Ciência de Dados">Ciência de Dados</option>
                            <option value="Tecnologia em Geral">Tecnologia em Geral</option>
                            <option value="Apenas explorar">Apenas explorar</option>
                        </select>
                    </div>
                    <div>
                        <label for="objective-select" class="block text-left text-lg font-bold text-slate-700 mb-2">Seu principal objetivo no evento é:</label>
                        <select id="objective-select" class="w-full p-4 text-lg border-2 border-slate-300 rounded-full focus:outline-none focus:ring-4 focus:ring-indigo-300 transition duration-300">
                            <option value="conhecer os projetos">Conhecer os projetos dos alunos</option>
                            <option value="assistir palestras">Assistir palestras / workshops</option>
                            <option value="fazer networking">Fazer networking</option>
                            <option value="conhecer a Fatec">Conhecer a Fatec</option>
                            <option value="apenas explorar">Apenas explorar</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="block mx-auto bg-indigo-600 text-white rounded-full p-4 mt-8 text-xl font-bold hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition-transform duration-200 active:scale-95 px-12">
                    Iniciar Conversa
                </button>
            </form>
        </div>

        <div id="splash-avatar-container">
            <img src="./assets/avatar_fechada.png" alt="Avatar da LIA">
        </div>

    </div>

    <div id="main-container" style="display: none;">
        
        <div id="chat-container" class="bg-white shadow-2xl rounded-2xl overflow-hidden">
            <header class="bg-zinc-900 text-white p-6 shadow-md z-10 flex items-center justify-center relative">
                <div class="absolute left-6 top-1/2 -translate-y-1/2 flex space-x-2">
                    <button id="restart-button" title="Reiniciar Conversa" class="text-white p-2 rounded-full hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-400">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>
                    </button>
                    <button id="summarize-button" title="Resumir Conversa" class="text-white p-2 rounded-full hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-400 disabled:opacity-50">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 21h12a2 2 0 0 0 2-2v-2H10v2a2 2 0 1 1-4 0V5a2 2 0 1 0-4 0v14a2 2 0 0 0 2 2h4Z"/><path d="M10 17v-1a2 2 0 1 1 4 0v1"/><path d="M10 11v-1a2 2 0 1 1 4 0v1"/><path d="M10 5v-1a2 2 0 1 1 4 0v1"/></svg>
                    </button>
                </div>
                <div class="text-center">
                    <h1 class="text-3xl font-bold">LIA - Assistente de IA no Metaday</h1>
                    <p class="text-slate-300 text-lg mt-1">Como posso te ajudar hoje?</p>
                </div>
                <button id="toggle-tts-button" class="absolute right-6 top-1/2 -translate-y-1/2 text-white p-2 rounded-full hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-400"></button>
            </header>

            <main id="chat-messages" class="flex-1 p-8 overflow-y-auto"></main>

            <div id="preset-buttons-container" class="p-4 bg-slate-50 border-t border-slate-200">
                <div class="flex flex-wrap justify-center gap-3">
                    <button class="preset-button bg-slate-200 text-slate-800 py-2 px-4 rounded-full hover:bg-slate-300 transition-transform duration-200 active:scale-95">Quais os projetos de GNI?</button>
                    <button class="preset-button bg-slate-200 text-slate-800 py-2 px-4 rounded-full hover:bg-slate-300 transition-transform duration-200 active:scale-95">Onde encontro os projetos de Marketing?</button>
                    <button class="preset-button bg-slate-200 text-slate-800 py-2 px-4 rounded-full hover:bg-slate-300 transition-transform duration-200 active:scale-95">O que é o projeto da LIA?</button>
                    <button class="preset-button bg-slate-200 text-slate-800 py-2 px-4 rounded-full hover:bg-slate-300 transition-transform duration-200 active:scale-95">Onde será a apresentação de Pitch e Impressora 3D?</button>
                    <button class="preset-button bg-slate-200 text-slate-800 py-2 px-4 rounded-full hover:bg-slate-300 transition-transform duration-200 active:scale-95">Tem algum projeto de consultoria?</button>
                    <button class="preset-button bg-slate-200 text-slate-800 py-2 px-4 rounded-full hover:bg-slate-300 transition-transform duration-200 active:scale-95">Onde vai ser o podcast?</button>
                </div>
            </div>

            <footer class="p-6 bg-white border-t border-slate-200">
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <input type="text" id="message-input" placeholder="Digite sua mensagem aqui..." autocomplete="off" class="flex-1 p-4 text-lg border-2 border-slate-300 rounded-full focus:outline-none focus:ring-4 focus:ring-indigo-300 transition duration-300"/>
                    
                    <button id="suggest-topic-button" title="Sugerir Tópico" class="w-16 h-16 rounded-full flex items-center justify-center flex-shrink-0 bg-amber-400 text-white hover:bg-amber-500 focus:outline-none focus:ring-4 focus:ring-amber-300 transition-transform duration-200 active:scale-95 disabled:bg-slate-400">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>
                    </button>
                    <button id="send-text-button" type="submit" form="chat-form" class="w-16 h-16 rounded-full flex items-center justify-center flex-shrink-0 bg-indigo-600 text-white hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition-transform duration-200 active:scale-95 disabled:bg-slate-400 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 3 3 9-3 9 19-9Z"/><path d="M6 12h16"/></svg>
                    </button>
                    <button id="mic-button" class="w-16 h-16 rounded-full flex items-center justify-center flex-shrink-0 bg-red-500 text-white hover:bg-red-600 focus:outline-none focus:ring-4 focus:ring-red-300 transition-transform duration-200 active:scale-95 disabled:bg-slate-400">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
                    </button>
                </div>
                <form id="chat-form" class="hidden"></form>
            </footer>
        </div>

        <div id="avatar-container">
            <img id="avatar-image" src="./assets/avatar_fechada.png" alt="Avatar da Assistente Virtual">
        </div>
    </div>

    <div vw class="enabled">
        <div vw-access-button class="active"></div>
        <div vw-plugin-wrapper>
            <div class="vw-plugin-top-wrapper"></div>
        </div>
    </div>
    <script src="https://vlibras.gov.br/app/vlibras-plugin.js"></script>

    <!-- <script>
        marked.setOptions({ breaks: true });
        new window.VLibras.Widget('https://vlibras.gov.br/app');

        // --- Constantes dos Elementos da UI ---
        const messageInput = document.getElementById('message-input');
        const chatMessages = document.getElementById('chat-messages');
        const micButton = document.getElementById('mic-button');
        const summarizeButton = document.getElementById('summarize-button');
        const suggestTopicButton = document.getElementById('suggest-topic-button');
        const sendTextButton = document.getElementById('send-text-button');
        const ttsButton = document.getElementById('toggle-tts-button');
        const avatarImage = document.getElementById('avatar-image');
        const restartButton = document.getElementById('restart-button');
        const presetButtonsContainer = document.getElementById('preset-buttons-container');
        
        const splashScreen = document.getElementById('splash-screen');
        const mainContainer = document.getElementById('main-container');
        const startForm = document.getElementById('start-form');
        const nameInput = document.getElementById('name-input');
        
        // Antes
        // const backendUrl = 'http://127.0.0.1:5000/chat';

        // Depois
        const backendUrl = `${window.location.origin}/chat`;    

        // LÓGICA DO TIMER DE INATIVIDADE
        let inactivityTimer;
        const inactivityTimeout = 60000; 

        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                console.log("Usuário inativo. Voltando para a tela inicial.");
                window.location.reload();
            }, inactivityTimeout);
        }

        const chatLog = []; // já preenche com mensagens do usuário e bot

        // Exemplo de adicionar mensagens ao log
        function addMessage(role, content) {
            chatLog.push({ role, content });
        }

        // // Ao enviar formulário
        // document.getElementById("form-submit").addEventListener("click", () => {
        //     const name = document.getElementById("name-input").value;
        //     const role = document.getElementById("role-select").value;
        //     const interestArea = document.getElementById("interest-area-select").value;
        //     const objective = document.getElementById("objective-select").value;

        //     const payload = {
        //         name,
        //         role,
        //         interestArea,
        //         objective,
        //         chatLog
        //     };

        //     fetch("/save-form", {
        //         method: "POST",
        //         headers: { "Content-Type": "application/json" },
        //         body: JSON.stringify(payload)
        //     })
        //     .then(res => res.json())
        //     .then(data => console.log("Salvo com sucesso!", data))
        //     .catch(err => console.error(err));
        // });



        // --- LÓGICA DA TELA INICIAL ---
        startForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = nameInput.value.trim();
            const role = document.getElementById('role-select').value;
            const interestArea = document.getElementById('interest-area-select').value;
            const objective = document.getElementById('objective-select').value;

            console.log("Perfil do Usuário:", { name, role, interestArea, objective });

            if (name) {
                splashScreen.style.display = 'none';
                mainContainer.style.display = 'flex';
                
                const welcomeMessage = `Olá, <strong>${name}</strong>! 👋<br>Que legal que um(a) <strong>${role}</strong> com interesse em <strong>${interestArea}</strong> veio nos visitar! Estou pronta para te ajudar a <strong>${objective}</strong>. Sobre o que quer saber primeiro?`;
                appendMessage('bot', welcomeMessage);

                resetInactivityTimer();
                window.addEventListener('mousemove', resetInactivityTimer);
                window.addEventListener('keydown', resetInactivityTimer);
                window.addEventListener('click', resetInactivityTimer);
                window.addEventListener('scroll', resetInactivityTimer, true);
            }
        });

        messageInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendTextButton.click();
            }
        });

        // --- LÓGICA DE ANIMAÇÃO DO AVATAR ---
        let mouthAnimationInterval;
        const avatar_boca_fechada = './assets/avatar_fechada.png';
        const avatar_boca_aberta = './assets/avatar_aberta.png';

        // function startTalkingAnimation() {
        //     stopTalkingAnimation(); 
        //     let isMouthOpen = false;
        //     mouthAnimationInterval = setInterval(() => {
        //         // avatarImage.src = isMouthOpen ? avatar_boca_fechada : avatar_boca_aberta;
        //         avatarImage.src = (isMouthOpen ? avatar_boca_fechada : avatar_boca_aberta) + "?ts=" + new Date().getTime();
        //         isMouthOpen = !isMouthOpen;
        //     }, 250);
        // }

        function startTalkingAnimation() {
            stopTalkingAnimation(); 
            let isMouthOpen = false;
            
            const updateAvatar = () => {
                const nextSrc = isMouthOpen ? avatar_boca_fechada : avatar_boca_aberta;
                
                // 1. Cria uma URL ÚNICA para Cache Busting
                const uniqueSrc = nextSrc + "?ts=" + new Date().getTime();
                
                // 2. Cria um novo objeto Image para forçar o recarregamento imediato
                const newImage = new Image();
                
                // 3. Define um listener para garantir que só troque quando carregar
                newImage.onload = () => {
                    avatarImage.src = uniqueSrc;
                };

                // 4. Define o source da nova imagem, forçando o fetch
                newImage.src = uniqueSrc;

                isMouthOpen = !isMouthOpen;
            };

            mouthAnimationInterval = setInterval(updateAvatar, 250);
        }

        function stopTalkingAnimation() {
            if (mouthAnimationInterval) {
                clearInterval(mouthAnimationInterval);
                mouthAnimationInterval = null;
            }
            avatarImage.src = avatar_boca_fechada;
        }

        // --- LÓGICA DE GRAVAÇÃO DE VOZ ---
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        micButton.addEventListener('click', async () => {
            if (isRecording) {
                mediaRecorder.stop();
            } else {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.start();
                    isRecording = true;
                    audioChunks = [];
                    micButton.classList.add('recording', 'bg-red-700');
                    micButton.classList.remove('bg-red-500');
                    messageInput.placeholder = "Gravando... Clique para parar.";
                    setUiDisabled(true, true);
                    mediaRecorder.addEventListener("dataavailable", event => { audioChunks.push(event.data); });
                    mediaRecorder.addEventListener("stop", () => {
                        isRecording = false;
                        micButton.classList.remove('recording', 'bg-red-700');
                        micButton.classList.add('bg-red-500');
                        messageInput.placeholder = "Digite sua mensagem aqui...";
                        setUiDisabled(false);
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        sendAudioToServer(audioBlob);
                        stream.getTracks().forEach(track => track.stop());
                    });
                } catch (err) {
                    console.error("Erro ao acessar o microfone:", err);
                    alert("Não foi possível acessar o microfone. Verifique as permissões.");
                }
            }
        });

        // --- LÓGICA DE SUBMISSÃO (Texto, Áudio e Botões Pré-programados) ---
        document.getElementById('chat-form').addEventListener('submit', handleTextSubmit);
        sendTextButton.addEventListener('click', handleTextSubmit);
        
        presetButtonsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('preset-button')) {
                const question = e.target.textContent;
                handlePresetClick(question);
            }
        });

        async function handleTextSubmit(e) {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (!message) return;
            appendMessage('user', message);
            messageInput.value = '';
            if(presetButtonsContainer) presetButtonsContainer.style.display = 'none';
            await fetchBotReply({ message: message });
        }

        async function handlePresetClick(question) {
            appendMessage('user', question);
            if(presetButtonsContainer) presetButtonsContainer.style.display = 'none';
            await fetchBotReply({ message: question, isPreset: true });
        }

        async function sendAudioToServer(audioBlob) {
            const formData = new FormData();
            formData.append('audio_file', audioBlob, 'user_audio.webm');
            appendMessage('user', '<i>Mensagem de voz enviada...</i>');
            if(presetButtonsContainer) presetButtonsContainer.style.display = 'none';
            await fetchBotReply({ body: formData, isAudio: true });
        }

        async function fetchBotReply(payload) {
            setUiDisabled(true);
            showTypingIndicator();
            try {
                let requestOptions;
                if (payload.isAudio) {
                    requestOptions = { method: 'POST', body: payload.body };
                } else {
                    const body = payload.isPreset 
                        ? { preset_question: payload.message, tts_enabled: isTtsEnabled } 
                        : { message: payload.message, tts_enabled: isTtsEnabled };
                    requestOptions = { 
                        method: 'POST', 
                        headers: {'Content-Type': 'application/json'}, 
                        body: JSON.stringify(body) 
                    };
                }
                
                const response = await fetch(backendUrl, requestOptions);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                
                removeTypingIndicator();
                appendMessage('bot', data.reply);
                playAudioFromData(data.audioData);

            } catch (error) {
                handleFetchError(error);
            } finally {
                setUiDisabled(false);
                messageInput.focus();
                if (presetButtonsContainer) {
                    presetButtonsContainer.style.display = 'block'; 
                }
            }
        }
        
        // --- LÓGICA: RESUMIR E SUGERIR ---
        summarizeButton.addEventListener('click', async () => {
            showTypingIndicator(); setUiDisabled(true);
            try {
                const response = await fetch(`${backendUrl.replace('/chat', '/summarize')}`, { method: 'POST' });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (data.summary) { appendSystemMessage(data.summary); } 
                else if (data.error) { appendSystemMessage(`<strong>Erro:</strong> ${data.error}`); }
            } catch (error) {
                console.error('Erro ao resumir conversa:', error);
                appendSystemMessage('<strong>Erro:</strong> Não foi possível conectar ao servidor para resumir.');
            } finally { removeTypingIndicator(); setUiDisabled(false); }
        });

        suggestTopicButton.addEventListener('click', async () => {
            const originalPlaceholder = messageInput.placeholder;
            messageInput.placeholder = "Buscando uma ideia..."; setUiDisabled(true);
            try {
                const response = await fetch(`${backendUrl.replace('/chat', '/suggest-topic')}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (data.topic) { messageInput.value = data.topic; messageInput.focus(); } 
                else { messageInput.placeholder = "Erro ao sugerir. Tente novamente."; setTimeout(() => { messageInput.placeholder = originalPlaceholder; }, 2000); }
            } catch (error) {
                console.error('Erro ao sugerir tópico:', error);
                messageInput.placeholder = "Erro de conexão."; setTimeout(() => { messageInput.placeholder = originalPlaceholder; }, 2000);
            } finally { setUiDisabled(false); if (!messageInput.value) { messageInput.placeholder = originalPlaceholder; } }
        });

        // --- LÓGICA: REINICIAR CONVERSA ---
        restartButton.addEventListener('click', async () => {
            try {
                const response = await fetch(`${backendUrl.replace('/chat', '/restart')}`, { method: 'POST' });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                window.location.reload();

            } catch (error) {
                console.error('Erro ao reiniciar a conversa:', error);
                appendSystemMessage('<strong>Erro:</strong> Não foi possível conectar ao servidor para reiniciar a conversa.');
            }
        });

        // --- FUNÇÕES AUXILIARES DA UI ---
        function setUiDisabled(isDisabled, recording = false) { messageInput.disabled = isDisabled; sendTextButton.disabled = isDisabled; suggestTopicButton.disabled = isDisabled; summarizeButton.disabled = isDisabled; micButton.disabled = isDisabled && !recording; }
        function handleFetchError(error) { console.error('Erro de comunicação com o backend:', error); removeTypingIndicator(); appendMessage('bot', 'Desculpe, ocorreu um erro de conexão.'); }
        function appendMessage(sender, message) {
            const wrapper = document.createElement('div'); wrapper.classList.add('flex', 'mb-6');
            const bubble = document.createElement('div'); bubble.classList.add('p-4', 'rounded-2xl', 'max-w-lg', 'text-lg');
            if (sender === 'bot') { wrapper.classList.add('justify-start'); bubble.classList.add('bg-zinc-900', 'text-white', 'rounded-bl-none'); bubble.innerHTML = marked.parse(message); } 
            else { wrapper.classList.add('justify-end'); bubble.classList.add('bg-slate-200', 'text-slate-800', 'rounded-br-none'); bubble.innerHTML = message; }
            wrapper.appendChild(bubble); chatMessages.appendChild(wrapper);
            if (typeof MathJax !== "undefined" && sender === 'bot') { MathJax.typesetPromise([wrapper]).catch((err) => console.log('Erro MathJax:', err)); }
            chatMessages.scrollTop = chatMessages.scrollHeight;
        };
        function appendSystemMessage(message) {
            const wrapper = document.createElement('div'); wrapper.classList.add('flex', 'justify-center', 'my-4', 'mx-2');
            const bubble = document.createElement('div'); bubble.classList.add('bg-slate-600', 'text-white', 'p-3', 'rounded-xl', 'max-w-xl', 'text-base', 'italic');
            bubble.innerHTML = `✨ **Resumo da Conversa:**<br>${marked.parse(message)}`; wrapper.appendChild(bubble); chatMessages.appendChild(wrapper);
            if (typeof MathJax !== "undefined") { MathJax.typesetPromise([wrapper]).catch((err) => console.log('Erro MathJax:', err)); }
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        const showTypingIndicator=()=>{const t=document.createElement('div');t.id='typing-indicator';t.classList.add('flex','justify-start','mb-6');t.innerHTML=`<div class="bg-zinc-900 text-white p-4 rounded-2xl rounded-bl-none"><div class="flex items-center space-x-1"><span class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay:0s"></span><span class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay:0.2s"></span><span class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay:0.4s"></span></div></div>`;chatMessages.appendChild(t);chatMessages.scrollTop=chatMessages.scrollHeight};
        const removeTypingIndicator=()=>{const t=document.getElementById('typing-indicator');if(t){t.remove()}};
        
        // --- Lógica de TTS ---
        let isTtsEnabled=true;let currentAudio=null;const iconSoundOn=`<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>`;const iconSoundOff=`<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="22" x2="16" y1="9" y2="15"/><line x1="16" x2="22" y1="9" y2="15"/></svg>`;
        function base64ToArrayBuffer(b){const s=window.atob(b);const l=s.length;const B=new Uint8Array(l);for(let i=0;i<l;i++){B[i]=s.charCodeAt(i)}return B.buffer}
        function pcmToWavBlob(d){const r=24000;const p=base64ToArrayBuffer(d);const D=new Int16Array(p);const h=new ArrayBuffer(44);const v=new DataView(h);v.setUint32(0,1380533830,false);v.setUint32(4,36+D.byteLength,true);v.setUint32(8,1463899717,false);v.setUint32(12,1718449184,false);v.setUint32(16,16,true);v.setUint16(20,1,true);v.setUint16(22,1,true);v.setUint32(24,r,true);v.setUint32(28,r*2,true);v.setUint16(32,2,true);v.setUint16(34,16,true);v.setUint32(36,1684108385,false);v.setUint32(40,D.byteLength,true);return new Blob([h,D],{type:'audio/wav'})}
        
        const playAudioFromData=(d)=>{if(currentAudio){currentAudio.pause()}stopTalkingAnimation();if(!isTtsEnabled||!d)return;try{const b=pcmToWavBlob(d);const u=URL.createObjectURL(b);currentAudio=new Audio(u);currentAudio.addEventListener('play',startTalkingAnimation);currentAudio.addEventListener('ended',stopTalkingAnimation);currentAudio.addEventListener('pause',stopTalkingAnimation);currentAudio.addEventListener('error',stopTalkingAnimation);currentAudio.play()}catch(e){console.error("Erro ao tocar áudio:",e)}};
        const updateTtsButtonIcon=()=>{ttsButton.innerHTML=isTtsEnabled?iconSoundOn:iconSoundOff};
        ttsButton.addEventListener('click',()=>{isTtsEnabled=!isTtsEnabled;updateTtsButtonIcon();if(!isTtsEnabled&&currentAudio){currentAudio.pause()}});
        updateTtsButtonIcon();
    </script> -->

    <!-- <script>
        marked.setOptions({ breaks: true });
        new window.VLibras.Widget('https://vlibras.gov.br/app');

        // --- Constantes dos Elementos da UI ---
        const messageInput = document.getElementById('message-input');
        const chatMessages = document.getElementById('chat-messages');
        const micButton = document.getElementById('mic-button');
        const summarizeButton = document.getElementById('summarize-button');
        const suggestTopicButton = document.getElementById('suggest-topic-button');
        const sendTextButton = document.getElementById('send-text-button');
        const ttsButton = document.getElementById('toggle-tts-button');
        const avatarImage = document.getElementById('avatar-image');
        const restartButton = document.getElementById('restart-button');
        const presetButtonsContainer = document.getElementById('preset-buttons-container');
        
        const splashScreen = document.getElementById('splash-screen');
        const mainContainer = document.getElementById('main-container');
        const startForm = document.getElementById('start-form');
        const nameInput = document.getElementById('name-input');
        
        // Configuração da URL do Backend (correta para ambiente local e Render)
        const backendUrl = `${window.location.origin}/chat`;    

        // LÓGICA DO TIMER DE INATIVIDADE
        let inactivityTimer;
        const inactivityTimeout = 60000; 

        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                console.log("Usuário inativo. Voltando para a tela inicial.");
                window.location.reload();
            }, inactivityTimeout);
        }

        const chatLog = []; // já preenche com mensagens do usuário e bot

        // Exemplo de adicionar mensagens ao log
        function addMessage(role, content) {
            chatLog.push({ role, content });
        }

        // REMOÇÃO DO CÓDIGO DUPLICADO QUE CAUSAVA O TypeError - OK

        // --- LÓGICA DA TELA INICIAL (AGORA INCLUI O SALVAMENTO) ---
        startForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const name = nameInput.value.trim();
            const role = document.getElementById('role-select').value;
            const interestArea = document.getElementById('interest-area-select').value;
            const objective = document.getElementById('objective-select').value;

            console.log("Perfil do Usuário:", { name, role, interestArea, objective });

            if (name) {
                const payload = {
                    name,
                    role,
                    interestArea,
                    objective,
                };

                // NOVO CÓDIGO: Envia os dados para o servidor
                // (Assumindo que você criará a rota /save-form no Flask)
                fetch("/save-form", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                })
                .then(res => {
                    if (!res.ok) {
                        console.error("Erro ao salvar perfil. Status:", res.status);
                    }
                    // Continua mesmo se o log falhar, para não quebrar a experiência do usuário
                })
                .catch(err => console.error("Erro de rede ao salvar perfil:", err));
                // FIM DO NOVO CÓDIGO

                // Lógica de transição de tela
                splashScreen.style.display = 'none';
                mainContainer.style.display = 'flex';
                
                const welcomeMessage = `Olá, <strong>${name}</strong>! 👋<br>Que legal que um(a) <strong>${role}</strong> com interesse em <strong>${interestArea}</strong> veio nos visitar! Estou pronta para te ajudar a <strong>${objective}</strong>. Sobre o que quer saber primeiro?`;
                appendMessage('bot', welcomeMessage);

                resetInactivityTimer();
                window.addEventListener('mousemove', resetInactivityTimer);
                window.addEventListener('keydown', resetInactivityTimer);
                window.addEventListener('click', resetInactivityTimer);
                window.addEventListener('scroll', resetInactivityTimer, true);
            }
        });

        messageInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendTextButton.click();
            }
        });

        // --- LÓGICA DE ANIMAÇÃO DO AVATAR ---
        let mouthAnimationInterval;
        const avatar_boca_fechada = './assets/avatar_fechada.png';
        const avatar_boca_aberta = './assets/avatar_aberta.png';

        function startTalkingAnimation() {
            stopTalkingAnimation(); 
            let isMouthOpen = false;
            
            const updateAvatar = () => {
                const nextSrc = isMouthOpen ? avatar_boca_fechada : avatar_boca_aberta;
                
                // 1. Cria uma URL ÚNICA para Cache Busting
                const uniqueSrc = nextSrc + "?ts=" + new Date().getTime();
                
                // 2. Cria um novo objeto Image para forçar o recarregamento imediato
                const newImage = new Image();
                
                // 3. Define um listener para garantir que só troque quando carregar
                newImage.onload = () => {
                    avatarImage.src = uniqueSrc;
                };

                // 4. Define o source da nova imagem, forçando o fetch
                newImage.src = uniqueSrc;

                isMouthOpen = !isMouthOpen;
            };

            mouthAnimationInterval = setInterval(updateAvatar, 250);
        }

        function stopTalkingAnimation() {
            if (mouthAnimationInterval) {
                clearInterval(mouthAnimationInterval);
                mouthAnimationInterval = null;
            }
            avatarImage.src = avatar_boca_fechada;
        }

        // --- LÓGICA DE GRAVAÇÃO DE VOZ ---
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        micButton.addEventListener('click', async () => {
            if (isRecording) {
                mediaRecorder.stop();
            } else {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.start();
                    isRecording = true;
                    audioChunks = [];
                    micButton.classList.add('recording', 'bg-red-700');
                    micButton.classList.remove('bg-red-500');
                    messageInput.placeholder = "Gravando... Clique para parar.";
                    setUiDisabled(true, true);
                    mediaRecorder.addEventListener("dataavailable", event => { audioChunks.push(event.data); });
                    mediaRecorder.addEventListener("stop", () => {
                        isRecording = false;
                        micButton.classList.remove('recording', 'bg-red-700');
                        micButton.classList.add('bg-red-500');
                        messageInput.placeholder = "Digite sua mensagem aqui...";
                        setUiDisabled(false);
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        sendAudioToServer(audioBlob);
                        stream.getTracks().forEach(track => track.stop());
                    });
                } catch (err) {
                    console.error("Erro ao acessar o microfone:", err);
                    alert("Não foi possível acessar o microfone. Verifique as permissões.");
                }
            }
        });

        // --- LÓGICA DE SUBMISSÃO (Texto, Áudio e Botões Pré-programados) ---
        document.getElementById('chat-form').addEventListener('submit', handleTextSubmit);
        sendTextButton.addEventListener('click', handleTextSubmit);
        
        presetButtonsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('preset-button')) {
                const question = e.target.textContent;
                handlePresetClick(question);
            }
        });

        async function handleTextSubmit(e) {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (!message) return;
            appendMessage('user', message);
            messageInput.value = '';
            if(presetButtonsContainer) presetButtonsContainer.style.display = 'none';
            await fetchBotReply({ message: message });
        }

        async function handlePresetClick(question) {
            appendMessage('user', question);
            if(presetButtonsContainer) presetButtonsContainer.style.display = 'none';
            await fetchBotReply({ message: question, isPreset: true });
        }

        async function sendAudioToServer(audioBlob) {
            const formData = new FormData();
            formData.append('audio_file', audioBlob, 'user_audio.webm');
            appendMessage('user', '<i>Mensagem de voz enviada...</i>');
            if(presetButtonsContainer) presetButtonsContainer.style.display = 'none';
            await fetchBotReply({ body: formData, isAudio: true });
        }

        async function fetchBotReply(payload) {
            setUiDisabled(true);
            showTypingIndicator();
            try {
                let requestOptions;
                if (payload.isAudio) {
                    requestOptions = { method: 'POST', body: payload.body };
                } else {
                    const body = payload.isPreset 
                        ? { preset_question: payload.message, tts_enabled: isTtsEnabled } 
                        : { message: payload.message, tts_enabled: isTtsEnabled };
                    requestOptions = { 
                        method: 'POST', 
                        headers: {'Content-Type': 'application/json'}, 
                        body: JSON.stringify(body) 
                    };
                }
                
                const response = await fetch(backendUrl, requestOptions);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                
                removeTypingIndicator();
                appendMessage('bot', data.reply);
                playAudioFromData(data.audioData);

            } catch (error) {
                handleFetchError(error);
            } finally {
                setUiDisabled(false);
                messageInput.focus();
                if (presetButtonsContainer) {
                    presetButtonsContainer.style.display = 'block'; 
                }
            }
        }
        
        // --- LÓGICA: RESUMIR E SUGERIR ---
        summarizeButton.addEventListener('click', async () => {
            showTypingIndicator(); setUiDisabled(true);
            try {
                const response = await fetch(`${backendUrl.replace('/chat', '/summarize')}`, { method: 'POST' });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (data.summary) { appendSystemMessage(data.summary); } 
                else if (data.error) { appendSystemMessage(`<strong>Erro:</strong> ${data.error}`); }
            } catch (error) {
                console.error('Erro ao resumir conversa:', error);
                appendSystemMessage('<strong>Erro:</strong> Não foi possível conectar ao servidor para resumir.');
            } finally { removeTypingIndicator(); setUiDisabled(false); }
        });

        suggestTopicButton.addEventListener('click', async () => {
            const originalPlaceholder = messageInput.placeholder;
            messageInput.placeholder = "Buscando uma ideia..."; setUiDisabled(true);
            try {
                const response = await fetch(`${backendUrl.replace('/chat', '/suggest-topic')}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (data.topic) { messageInput.value = data.topic; messageInput.focus(); } 
                else { messageInput.placeholder = "Erro ao sugerir. Tente novamente."; setTimeout(() => { messageInput.placeholder = originalPlaceholder; }, 2000); }
            } catch (error) {
                console.error('Erro ao sugerir tópico:', error);
                messageInput.placeholder = "Erro de conexão."; setTimeout(() => { messageInput.placeholder = originalPlaceholder; }, 2000);
            } finally { setUiDisabled(false); if (!messageInput.value) { messageInput.placeholder = originalPlaceholder; } }
        });

        // --- LÓGICA: REINICIAR CONVERSA ---
        restartButton.addEventListener('click', async () => {
            try {
                const response = await fetch(`${backendUrl.replace('/chat', '/restart')}`, { method: 'POST' });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                window.location.reload();

            } catch (error) {
                console.error('Erro ao reiniciar a conversa:', error);
                appendSystemMessage('<strong>Erro:</strong> Não foi possível conectar ao servidor para reiniciar a conversa.');
            }
        });

        // --- FUNÇÕES AUXILIARES DA UI ---
        function setUiDisabled(isDisabled, recording = false) { messageInput.disabled = isDisabled; sendTextButton.disabled = isDisabled; suggestTopicButton.disabled = isDisabled; summarizeButton.disabled = isDisabled; micButton.disabled = isDisabled && !recording; }
        function handleFetchError(error) { console.error('Erro de comunicação com o backend:', error); removeTypingIndicator(); appendMessage('bot', 'Desculpe, ocorreu um erro de conexão.'); }
        function appendMessage(sender, message) {
            const wrapper = document.createElement('div'); wrapper.classList.add('flex', 'mb-6');
            const bubble = document.createElement('div'); bubble.classList.add('p-4', 'rounded-2xl', 'max-w-lg', 'text-lg');
            if (sender === 'bot') { wrapper.classList.add('justify-start'); bubble.classList.add('bg-zinc-900', 'text-white', 'rounded-bl-none'); bubble.innerHTML = marked.parse(message); } 
            else { wrapper.classList.add('justify-end'); bubble.classList.add('bg-slate-200', 'text-slate-800', 'rounded-br-none'); bubble.innerHTML = message; }
            wrapper.appendChild(bubble); chatMessages.appendChild(wrapper);
            if (typeof MathJax !== "undefined" && sender === 'bot') { MathJax.typesetPromise([wrapper]).catch((err) => console.log('Erro MathJax:', err)); }
            chatMessages.scrollTop = chatMessages.scrollHeight;
        };
        function appendSystemMessage(message) {
            const wrapper = document.createElement('div'); wrapper.classList.add('flex', 'justify-center', 'my-4', 'mx-2');
            const bubble = document.createElement('div'); bubble.classList.add('bg-slate-600', 'text-white', 'p-3', 'rounded-xl', 'max-w-xl', 'text-base', 'italic');
            bubble.innerHTML = `✨ **Resumo da Conversa:**<br>${marked.parse(message)}`; wrapper.appendChild(bubble); chatMessages.appendChild(wrapper);
            if (typeof MathJax !== "undefined") { MathJax.typesetPromise([wrapper]).catch((err) => console.log('Erro MathJax:', err)); }
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        const showTypingIndicator=()=>{const t=document.createElement('div');t.id='typing-indicator';t.classList.add('flex','justify-start','mb-6');t.innerHTML=`<div class="bg-zinc-900 text-white p-4 rounded-2xl rounded-bl-none"><div class="flex items-center space-x-1"><span class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay:0s"></span><span class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay:0.2s"></span><span class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay:0.4s"></span></div></div>`;chatMessages.appendChild(t);chatMessages.scrollTop=chatMessages.scrollHeight};
        const removeTypingIndicator=()=>{const t=document.getElementById('typing-indicator');if(t){t.remove()}};
        
        // --- Lógica de TTS ---
        let isTtsEnabled=true;let currentAudio=null;const iconSoundOn=`<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>`;const iconSoundOff=`<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="22" x2="16" y1="9" y2="15"/><line x1="16" x2="22" y1="9" y2="15"/></svg>`;
        function base64ToArrayBuffer(b){const s=window.atob(b);const l=s.length;const B=new Uint8Array(l);for(let i=0;i<l;i++){B[i]=s.charCodeAt(i)}return B.buffer}
        function pcmToWavBlob(d){const r=24000;const p=base64ToArrayBuffer(d);const D=new Int16Array(p);const h=new ArrayBuffer(44);const v=new DataView(h);v.setUint32(0,1380533830,false);v.setUint32(4,36+D.byteLength,true);v.setUint32(8,1463899717,false);v.setUint32(12,1718449184,false);v.setUint32(16,16,true);v.setUint16(20,1,true);v.setUint16(22,1,true);v.setUint32(24,r,true);v.setUint32(28,r*2,true);v.setUint16(32,2,true);v.setUint16(34,16,true);v.setUint32(36,1684108385,false);v.setUint32(40,D.byteLength,true);return new Blob([h,D],{type:'audio/wav'})}
        
        const playAudioFromData=(d)=>{if(currentAudio){currentAudio.pause()}stopTalkingAnimation();if(!isTtsEnabled||!d)return;try{const b=pcmToWavBlob(d);const u=URL.createObjectURL(b);currentAudio=new Audio(u);currentAudio.addEventListener('play',startTalkingAnimation);currentAudio.addEventListener('ended',stopTalkingAnimation);currentAudio.addEventListener('pause',stopTalkingAnimation);currentAudio.addEventListener('error',stopTalkingAnimation);currentAudio.play()}catch(e){console.error("Erro ao tocar áudio:",e)}};
        const updateTtsButtonIcon=()=>{ttsButton.innerHTML=isTtsEnabled?iconSoundOn:iconSoundOff};
        ttsButton.addEventListener('click',()=>{isTtsEnabled=!isTtsEnabled;updateTtsButtonIcon();if(!isTtsEnabled&&currentAudio){currentAudio.pause()}});
        updateTtsButtonIcon();
    </script> -->

    <script>
        marked.setOptions({ breaks: true });
        new window.VLibras.Widget('https://vlibras.gov.br/app');

        // --- Constantes dos Elementos da UI ---
        const messageInput = document.getElementById('message-input');
        const chatMessages = document.getElementById('chat-messages');
        const micButton = document.getElementById('mic-button');
        const summarizeButton = document.getElementById('summarize-button');
        const suggestTopicButton = document.getElementById('suggest-topic-button');
        const sendTextButton = document.getElementById('send-text-button');
        const ttsButton = document.getElementById('toggle-tts-button');
        const avatarImage = document.getElementById('avatar-image');
        const restartButton = document.getElementById('restart-button');
        const presetButtonsContainer = document.getElementById('preset-buttons-container');
        
        const splashScreen = document.getElementById('splash-screen');
        const mainContainer = document.getElementById('main-container');
        const startForm = document.getElementById('start-form');
        const nameInput = document.getElementById('name-input');
        
        // Configuração da URL do Backend (correta para ambiente local e Render)
        const backendUrl = `${window.location.origin}/chat`;    

        // --- CORREÇÃO 1: Armazenar o perfil do usuário no frontend ---
        // Esta variável guardará os dados do formulário após o login.
        let userProfile = {};

        // LÓGICA DO TIMER DE INATIVIDADE
        let inactivityTimer;
        const inactivityTimeout = 60000; 

        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                console.log("Usuário inativo. Voltando para a tela inicial.");
                window.location.reload();
            }, inactivityTimeout);
        }

        // --- LÓGICA DA TELA INICIAL (AGORA SALVA O PERFIL LOCALMENTE) ---
        startForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const name = nameInput.value.trim();
            const role = document.getElementById('role-select').value;
            const interestArea = document.getElementById('interest-area-select').value;
            const objective = document.getElementById('objective-select').value;

            if (name) {
                // Preenche a variável userProfile com os dados do formulário
                userProfile = {
                    name,
                    role,
                    interestArea,
                    objective,
                };

                // A chamada fetch para "/save-form" foi removida, pois não é mais necessária.
                // Os dados do perfil serão enviados com cada mensagem.

                // Lógica de transição de tela
                splashScreen.style.display = 'none';
                mainContainer.style.display = 'flex';
                
                const welcomeMessage = `Olá, <strong>${name}</strong>! 👋<br>Que legal que um(a) <strong>${role}</strong> com interesse em <strong>${interestArea}</strong> veio nos visitar! Estou pronta para te ajudar a <strong>${objective}</strong>. Sobre o que quer saber primeiro?`;
                appendMessage('bot', welcomeMessage);

                resetInactivityTimer();
                window.addEventListener('mousemove', resetInactivityTimer);
                window.addEventListener('keydown', resetInactivityTimer);
                window.addEventListener('click', resetInactivityTimer);
                window.addEventListener('scroll', resetInactivityTimer, true);
            }
        });

        messageInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendTextButton.click();
            }
        });

        // --- LÓGICA DE ANIMAÇÃO DO AVATAR ---
        let mouthAnimationInterval;
        const avatar_boca_fechada = './assets/avatar_fechada.png';
        const avatar_boca_aberta = './assets/avatar_aberta.png';

        function startTalkingAnimation() {
            stopTalkingAnimation(); 
            let isMouthOpen = false;
            
            const updateAvatar = () => {
                const nextSrc = isMouthOpen ? avatar_boca_fechada : avatar_boca_aberta;
                const uniqueSrc = nextSrc + "?ts=" + new Date().getTime();
                const newImage = new Image();
                newImage.onload = () => {
                    avatarImage.src = uniqueSrc;
                };
                newImage.src = uniqueSrc;
                isMouthOpen = !isMouthOpen;
            };
            mouthAnimationInterval = setInterval(updateAvatar, 250);
        }

        function stopTalkingAnimation() {
            if (mouthAnimationInterval) {
                clearInterval(mouthAnimationInterval);
                mouthAnimationInterval = null;
            }
            avatarImage.src = avatar_boca_fechada;
        }

        // --- LÓGICA DE GRAVAÇÃO DE VOZ ---
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        micButton.addEventListener('click', async () => {
            if (isRecording) {
                mediaRecorder.stop();
            } else {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.start();
                    isRecording = true;
                    audioChunks = [];
                    micButton.classList.add('recording', 'bg-red-700');
                    micButton.classList.remove('bg-red-500');
                    messageInput.placeholder = "Gravando... Clique para parar.";
                    setUiDisabled(true, true);
                    mediaRecorder.addEventListener("dataavailable", event => { audioChunks.push(event.data); });
                    mediaRecorder.addEventListener("stop", () => {
                        isRecording = false;
                        micButton.classList.remove('recording', 'bg-red-700');
                        micButton.classList.add('bg-red-500');
                        messageInput.placeholder = "Digite sua mensagem aqui...";
                        setUiDisabled(false);
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        sendAudioToServer(audioBlob);
                        stream.getTracks().forEach(track => track.stop());
                    });
                } catch (err) {
                    console.error("Erro ao acessar o microfone:", err);
                    alert("Não foi possível acessar o microfone. Verifique as permissões.");
                }
            }
        });

        // --- LÓGICA DE SUBMISSÃO (Texto, Áudio e Botões Pré-programados) ---
        document.getElementById('chat-form').addEventListener('submit', handleTextSubmit);
        sendTextButton.addEventListener('click', handleTextSubmit);
        
        presetButtonsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('preset-button')) {
                const question = e.target.textContent;
                handlePresetClick(question);
            }
        });

        async function handleTextSubmit(e) {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (!message) return;
            appendMessage('user', message);
            messageInput.value = '';
            if(presetButtonsContainer) presetButtonsContainer.style.display = 'none';
            await fetchBotReply({ message: message });
        }

        async function handlePresetClick(question) {
            appendMessage('user', question);
            if(presetButtonsContainer) presetButtonsContainer.style.display = 'none';
            await fetchBotReply({ message: question, isPreset: true });
        }

        // async function sendAudioToServer(audioBlob) {
        //     const formData = new FormData();
        //     formData.append('audio_file', audioBlob, 'user_audio.webm');
        //     appendMessage('user', '<i>Mensagem de voz enviada...</i>');
        //     if(presetButtonsContainer) presetButtonsContainer.style.display = 'none';
        //     await fetchBotReply({ body: formData, isAudio: true });
        // }

        async function sendAudioToServer(audioBlob) {
            const formData = new FormData();
            formData.append('audio_file', audioBlob, 'user_audio.webm');
            
            // --- LINHA ADICIONADA ---
            // Anexa o perfil do usuário como uma string JSON.
            formData.append("profile", JSON.stringify(userProfile));

            appendMessage('user', '<i>Mensagem de voz enviada...</i>');
            if(presetButtonsContainer) presetButtonsContainer.style.display = 'none';
            await fetchBotReply({ body: formData, isAudio: true });
        }

        async function fetchBotReply(payload) {
            setUiDisabled(true);
            showTypingIndicator();
            try {
                let requestOptions;
                if (payload.isAudio) {
                    requestOptions = { method: 'POST', body: payload.body };
                } else {
                    const body = payload.isPreset 
                        ? { preset_question: payload.message, tts_enabled: isTtsEnabled } 
                        : { message: payload.message, tts_enabled: isTtsEnabled };

                    // --- CORREÇÃO 2: Enviar o perfil junto com cada requisição ---
                    // Adicionamos o objeto 'userProfile' ao corpo (body) da requisição.
                    body.profile = userProfile;

                    requestOptions = { 
                        method: 'POST', 
                        headers: {'Content-Type': 'application/json'}, 
                        body: JSON.stringify(body) 
                    };
                }
                
                const response = await fetch(backendUrl, requestOptions);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                
                removeTypingIndicator();
                appendMessage('bot', data.reply);
                playAudioFromData(data.audioData);

            } catch (error) {
                handleFetchError(error);
            } finally {
                setUiDisabled(false);
                messageInput.focus();
                if (presetButtonsContainer) {
                    presetButtonsContainer.style.display = 'block'; 
                }
            }
        }
        
        // --- LÓGICA: RESUMIR E SUGERIR ---
        summarizeButton.addEventListener('click', async () => {
            showTypingIndicator(); setUiDisabled(true);
            try {
                const response = await fetch(`${backendUrl.replace('/chat', '/summarize')}`, { method: 'POST' });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (data.summary) { appendSystemMessage(data.summary); } 
                else if (data.error) { appendSystemMessage(`<strong>Erro:</strong> ${data.error}`); }
            } catch (error) {
                console.error('Erro ao resumir conversa:', error);
                appendSystemMessage('<strong>Erro:</strong> Não foi possível conectar ao servidor para resumir.');
            } finally { removeTypingIndicator(); setUiDisabled(false); }
        });

        suggestTopicButton.addEventListener('click', async () => {
            const originalPlaceholder = messageInput.placeholder;
            messageInput.placeholder = "Buscando uma ideia..."; setUiDisabled(true);
            try {
                const response = await fetch(`${backendUrl.replace('/chat', '/suggest-topic')}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (data.topic) { messageInput.value = data.topic; messageInput.focus(); } 
                else { messageInput.placeholder = "Erro ao sugerir. Tente novamente."; setTimeout(() => { messageInput.placeholder = originalPlaceholder; }, 2000); }
            } catch (error) {
                console.error('Erro ao sugerir tópico:', error);
                messageInput.placeholder = "Erro de conexão."; setTimeout(() => { messageInput.placeholder = originalPlaceholder; }, 2000);
            } finally { setUiDisabled(false); if (!messageInput.value) { messageInput.placeholder = originalPlaceholder; } }
        });

        // --- LÓGICA: REINICIAR CONVERSA ---
        restartButton.addEventListener('click', async () => {
            try {
                await fetch(`${backendUrl.replace('/chat', '/restart')}`, { method: 'POST' });
                window.location.reload();
            } catch (error) {
                console.error('Erro ao reiniciar a conversa:', error);
                appendSystemMessage('<strong>Erro:</strong> Não foi possível conectar ao servidor para reiniciar a conversa.');
            }
        });

        // const formData = new FormData();
        // formData.append("audio_file", audioBlob);
        // formData.append("profile", JSON.stringify({
        //     name: "Felipe",
        //     role: "Estudante",
        //     interestArea: "CDN",
        //     objective: "Testar chat"
        // }));


        // --- FUNÇÕES AUXILIARES DA UI ---
        function setUiDisabled(isDisabled, recording = false) { messageInput.disabled = isDisabled; sendTextButton.disabled = isDisabled; suggestTopicButton.disabled = isDisabled; summarizeButton.disabled = isDisabled; micButton.disabled = isDisabled && !recording; }
        function handleFetchError(error) { console.error('Erro de comunicação com o backend:', error); removeTypingIndicator(); appendMessage('bot', 'Desculpe, ocorreu um erro de conexão.'); }
        function appendMessage(sender, message) {
            const wrapper = document.createElement('div'); wrapper.classList.add('flex', 'mb-6');
            const bubble = document.createElement('div'); bubble.classList.add('p-4', 'rounded-2xl', 'max-w-lg', 'text-lg');
            if (sender === 'bot') { wrapper.classList.add('justify-start'); bubble.classList.add('bg-zinc-900', 'text-white', 'rounded-bl-none'); bubble.innerHTML = marked.parse(message); } 
            else { wrapper.classList.add('justify-end'); bubble.classList.add('bg-slate-200', 'text-slate-800', 'rounded-br-none'); bubble.innerHTML = message; }
            wrapper.appendChild(bubble); chatMessages.appendChild(wrapper);
            if (typeof MathJax !== "undefined" && sender === 'bot') { MathJax.typesetPromise([wrapper]).catch((err) => console.log('Erro MathJax:', err)); }
            chatMessages.scrollTop = chatMessages.scrollHeight;
        };
        function appendSystemMessage(message) {
            const wrapper = document.createElement('div'); wrapper.classList.add('flex', 'justify-center', 'my-4', 'mx-2');
            const bubble = document.createElement('div'); bubble.classList.add('bg-slate-600', 'text-white', 'p-3', 'rounded-xl', 'max-w-xl', 'text-base', 'italic');
            bubble.innerHTML = `✨ **Resumo da Conversa:**<br>${marked.parse(message)}`; wrapper.appendChild(bubble); chatMessages.appendChild(wrapper);
            if (typeof MathJax !== "undefined") { MathJax.typesetPromise([wrapper]).catch((err) => console.log('Erro MathJax:', err)); }
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        const showTypingIndicator=()=>{const t=document.createElement('div');t.id='typing-indicator';t.classList.add('flex','justify-start','mb-6');t.innerHTML=`<div class="bg-zinc-900 text-white p-4 rounded-2xl rounded-bl-none"><div class="flex items-center space-x-1"><span class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay:0s"></span><span class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay:0.2s"></span><span class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay:0.4s"></span></div></div>`;chatMessages.appendChild(t);chatMessages.scrollTop=chatMessages.scrollHeight};
        const removeTypingIndicator=()=>{const t=document.getElementById('typing-indicator');if(t){t.remove()}};
        
        // --- Lógica de TTS ---
        let isTtsEnabled=true;let currentAudio=null;const iconSoundOn=`<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>`;const iconSoundOff=`<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="22" x2="16" y1="9" y2="15"/><line x1="16" x2="22" y1="9" y2="15"/></svg>`;
        function base64ToArrayBuffer(b){const s=window.atob(b);const l=s.length;const B=new Uint8Array(l);for(let i=0;i<l;i++){B[i]=s.charCodeAt(i)}return B.buffer}
        function pcmToWavBlob(d){const r=24000;const p=base64ToArrayBuffer(d);const D=new Int16Array(p);const h=new ArrayBuffer(44);const v=new DataView(h);v.setUint32(0,1380533830,false);v.setUint32(4,36+D.byteLength,true);v.setUint32(8,1463899717,false);v.setUint32(12,1718449184,false);v.setUint32(16,16,true);v.setUint16(20,1,true);v.setUint16(22,1,true);v.setUint32(24,r,true);v.setUint32(28,r*2,true);v.setUint16(32,2,true);v.setUint16(34,16,true);v.setUint32(36,1684108385,false);v.setUint32(40,D.byteLength,true);return new Blob([h,D],{type:'audio/wav'})}
        
        const playAudioFromData=(d)=>{if(currentAudio){currentAudio.pause()}stopTalkingAnimation();if(!isTtsEnabled||!d)return;try{const b=pcmToWavBlob(d);const u=URL.createObjectURL(b);currentAudio=new Audio(u);currentAudio.addEventListener('play',startTalkingAnimation);currentAudio.addEventListener('ended',stopTalkingAnimation);currentAudio.addEventListener('pause',stopTalkingAnimation);currentAudio.addEventListener('error',stopTalkingAnimation);currentAudio.play()}catch(e){console.error("Erro ao tocar áudio:",e)}};
        const updateTtsButtonIcon=()=>{ttsButton.innerHTML=isTtsEnabled?iconSoundOn:iconSoundOff};
        ttsButton.addEventListener('click',()=>{isTtsEnabled=!isTtsEnabled;updateTtsButtonIcon();if(!isTtsEnabled&&currentAudio){currentAudio.pause()}});
        updateTtsButtonIcon();
    </script>

</body>
</html>